---
instance_groups:
- name: bbs
  jobs:
    - { name: consul_agent,     release: consul, consumes: { consul: { from: consul_server }}}
    - { name: bbs,              release: diego }
    - { name: metron_agent,     release: loggregator }
    - { name: cfdot,            release: diego }
    - { name: toolbelt,         release: toolbelt }
    - { name: toolbelt-quick,   release: toolbelt }
    - { name: toolbelt-veritas, release: toolbelt }

meta:
  bbs:
    ca_cert:     (( vault meta.vault "/ca:ca-pem" ))
    client_cert: (( vault meta.vault "/bbs/client:cert" ))
    client_key:  (( vault meta.vault "/bbs/client:key" ))
    require_ssl: true

  diegodb:
    host: (( grab params.diegodb_host ))
    port: (( param "What port is the diegodb listening on?" ))
    scheme: (( param "Specify the type of database the diegodb is (postgres, mysql)" ))
    user: (( param "Specify the user to connect to the diegodb" ))
    pass: (( param "Specify the password of the diegodb user" ))
    dbname: (( grab params.diegodb_name ))
    db_connection_string: (( params "The diegodb connection string was not specified in the subkit. This is a bug in the kit. Please contact your kit author for a fix." ))

properties:
  diego:
    bbs:
      active_key_label: key1
      encryption_keys:
        - label: key1
          passphrase: (( vault meta.vault "/diego/encryption_key:value" ))
      auctioneer: (( grab meta.auctioneer ))
      ca_cert: (( grab meta.bbs.ca_cert ))
      etcd:
        machines: []
        ca_cert: ~
        client_cert: ~
        client_key: ~
      rep: (( grab meta.rep ))
      server_cert: (( vault meta.vault "/bbs/server:cert" ))
      server_key:  (( vault meta.vault "/bbs/server:key" ))
      sql:
        ca_cert: null
        db_driver: (( grab meta.diegodb.scheme ))
        max_open_connections: 500
        require_ssl: null
        db_connection_string: (( grab meta.diegodb.db_connection_string ))
