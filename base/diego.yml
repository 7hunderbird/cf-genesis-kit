---
instance_groups:
- name: diego
  jobs:
  - { name: consul_agent,     release: consul, consumes: { consul: { from: consul_server }}}
  - name: auctioneer
    release: diego
    properties:
      diego:
        auctioneer:
          bbs:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.bbs.client ))
          rep:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.rep.client ))

          ca_cert: (( grab meta.certs.diego.ca ))
          .: (( inject meta.certs.diego.auctioneer.server ))

  - name: stager
    release: capi
    properties:
      capi:
        stager:
          bbs:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.bbs.client ))
          cc:
            basic_auth_password: (( grab meta.cc.internal_api_password ))
            basic_auth_username: (( grab meta.cc.internal_api_user ))

  - name: nsync
    release: capi
    properties:
      capi:
        nsync:
          bbs:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.bbs.client ))
          cc:
            base_url: (( concat "https://api." params.system_domain ))
            basic_auth_password: (( grab meta.cc.internal_api_password ))
            basic_auth_username: (( grab meta.cc.internal_api_user ))
          diego_privileged_containers: true

  - name: tps
    release: capi
    properties:
      capi:
        tps:
          bbs:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.bbs.client ))
          cc:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.tps.client ))

  - name: cc_uploader
    release: capi
    properties:
      capi:
        cc_uploader:
          cc:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.cc_uploader.client ))
          mutual_tls:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.cc_uploader.server ))

  - name: route_emitter
    release: diego
    properties:
      diego:
        route_emitter:
          bbs:
            ca_cert: (( grab meta.certs.diego.ca ))
            .: (( inject meta.certs.diego.bbs.client ))
          healthcheck_address: 127.0.0.1:17012 # to avoid conflict colocating with stager
          uaa:
            ca_cert: (( grab meta.certs.uaa.ca ))
            client_secret: (( grab meta.uaa.tcp_emitter_secret ))