---
instance_groups:
- name: haproxy
  vm_extensions:
  - cf-elb
  jobs:
  - { name: consul_agent,   release: consul, consumes: { consul: { as: consul } } }
  - { name: haproxy,        release: haproxy }
  - { name: metron_agent,   release: loggregator }
  - { name: toolbelt,       release: toolbelt }
  - { name: toolbelt-quick, release: toolbelt }
- name: router
  vm_extensions:
  - (( delete "cf-elb" ))

properties:
  ha_proxy:
    backend_servers: (( grab instance_groups.router.networks[0].static_ips ))
    internal_only_domains: (( grab params.internal_only_domains ))
    trusted_domain_cidrs: (( grab params.trusted_domain_cidrs ))
    ssl_pem: (( vault "/haproxy:ssl_pem" ))

    tcp:
    - name: wss
      port: 4443
      ssl: true
      backend_servers: (( grab instance_groups.router.networks[0].static_ips ))
      backend_port: 80
    - name: ssh-proxy
      port: 2222
      ssl: false
      backend_servers: (( grab instance_groups.access.networks[0].static_ips ))
      backend_port: 2222
